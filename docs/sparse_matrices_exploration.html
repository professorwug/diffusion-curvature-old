---

title: Landmark-based laziness


keywords: fastai
sidebar: home_sidebar



nb_path: "sparse_matrices_exploration.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: sparse_matrices_exploration.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">bsr_array</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;datasets/ipsc.txt&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">X_sparse</span> <span class="o">=</span> <span class="n">bsr_array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The thing is: going to a sparse matrix doesn't actually help us <em>at all</em> with the data, because we don't expect the data to have tons of zeros. But it's worth a try, I suppose.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>How do we multiply sparse matrices to a given power? We can do <code>@</code> for single powers, which works fairly well, and we can loop this following the log to achieve a matrix power to a given <code>t</code>.
But because the number of non-zero entries multiplies with matrix multiplication, we have to do the multiplications in the <em>landmarked</em> realm.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">graphtools</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">graphtools</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">n_landmark</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Interestingly, graphtools makes full use of all of the CPU cores. That's good programming.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sP</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">P</span> <span class="c1"># our sparse matrix</span>
<span class="n">P_landmarks</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">landmark_op</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;datasets/ipsc_sP.pickle&#39;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sP</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;datasets/ipsc_P_landmarks.pickle&#39;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">P_landmarks</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">G</span><span class="o">.</span><span class="n">transitions</span> <span class="c1"># is this a sparse matrix?</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">bsr_array</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">transitions</span><span class="p">)</span>
<span class="n">full_transitions</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">transitions</span>
<span class="n">P_l_bsr</span> <span class="o">=</span> <span class="n">bsr_array</span><span class="p">(</span><span class="n">P_landmarks</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">P_l_bsr</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;500x500 sparse matrix of type &#39;&lt;class &#39;numpy.float64&#39;&gt;&#39;
	with 81612 stored elements (blocksize = 1x1) in Block Sparse Row format&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;datasets/ipsc_transitions.pickle&#39;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">trans</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;220450x500 sparse matrix of type &#39;&lt;class &#39;numpy.float64&#39;&gt;&#39;
	with 110225000 stored elements (blocksize = 2x2) in Block Sparse Row format&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tolerance</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">full_transitions</span><span class="p">[</span><span class="n">full_transitions</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/adjourner/miniforge3/envs/graphcurvature/lib/python3.10/site-packages/scipy/sparse/_compressed.py:291: SparseEfficiencyWarning: Comparing a sparse matrix with a scalar greater than zero using &lt; is inefficient, try using &gt;= instead.
  warn(bad_scalar_msg, SparseEfficiencyWarning)
/Users/adjourner/miniforge3/envs/graphcurvature/lib/python3.10/site-packages/scipy/sparse/_index.py:146: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.
  self._set_arrayXarray(i, j, x)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">full_transitions</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;220450x500 sparse matrix of type &#39;&lt;class &#39;numpy.float64&#39;&gt;&#39;
	with 110225000 stored elements in Compressed Sparse Row format&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">trans</span> <span class="o">=</span> <span class="n">bsr_array</span><span class="p">(</span><span class="n">full_transitions</span><span class="p">)</span>
<span class="n">trans</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;220450x500 sparse matrix of type &#39;&lt;class &#39;numpy.float64&#39;&gt;&#39;
	with 110225000 stored elements (blocksize = 2x2) in Block Sparse Row format&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Just to see how fast this matrix multiplication is:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>(Unlike G.P, which has a lot of zeros, the transition matrix has values almost everywhere.)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">trans</span> <span class="o">@</span> <span class="n">P_landmarks</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[0.00000000e+00, 0.00000000e+00, 0.00000000e+00, ...,
        0.00000000e+00, 0.00000000e+00, 3.61419128e-05],
       [0.00000000e+00, 0.00000000e+00, 0.00000000e+00, ...,
        0.00000000e+00, 0.00000000e+00, 3.61432691e-05],
       [0.00000000e+00, 0.00000000e+00, 0.00000000e+00, ...,
        0.00000000e+00, 0.00000000e+00, 3.61432691e-05],
       ...,
       [0.00000000e+00, 1.58368284e-06, 1.01428970e-05, ...,
        1.81705757e-04, 1.38433002e-05, 1.99467440e-08],
       [0.00000000e+00, 9.30869523e-05, 0.00000000e+00, ...,
        1.26967055e-08, 8.85121684e-06, 0.00000000e+00],
       [0.00000000e+00, 0.00000000e+00, 0.00000000e+00, ...,
        2.67227408e-06, 0.00000000e+00, 0.00000000e+00]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="matpower" class="doc_header"><code>matpower</code><a href="https://github.com/professorwug/diffusion_curvature/tree/master/diffusion_curvature/core.py#L90" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>matpower</code>(<strong><code>A</code></strong>, <strong><code>t</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">matpower</span><span class="p">(</span><span class="n">P_l_bsr</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;500x500 sparse matrix of type &#39;&lt;class &#39;numpy.float64&#39;&gt;&#39;
	with 250000 stored elements (blocksize = 1x1) in Block Sparse Row format&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">A2_landmark_part_1</span> <span class="o">=</span> <span class="n">trans</span> <span class="o">@</span> <span class="n">matpower</span><span class="p">(</span><span class="n">P_landmarks</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">A2_landmark_part_1</span>
<span class="n">A2_landmark</span> <span class="o">=</span> <span class="n">A2_landmark_part_1</span> <span class="o">@</span> <span class="n">trans</span><span class="o">.</span><span class="n">T</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">A2_real</span> <span class="o">=</span> <span class="n">sP</span> <span class="o">@</span> <span class="n">sP</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sP</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-intense-fg ansi-bold">/Users/adjourner/Projects/diffusion_curvature/sparse_matrices_exploration.ipynb Cell 23&#39;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; &lt;a href=&#39;vscode-notebook-cell:/Users/adjourner/Projects/diffusion_curvature/sparse_matrices_exploration.ipynb#ch0000015?line=0&#39;&gt;1&lt;/a&gt;</span> sP

<span class="ansi-red-fg">NameError</span>: name &#39;sP&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">A8_manual</span> <span class="o">=</span> <span class="p">(</span><span class="n">sP</span> <span class="o">@</span> <span class="n">sP</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">A8_manual</span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-intense-fg ansi-bold">/Users/adjourner/Projects/diffusion_curvature/sparse_matrices_exploration.ipynb Cell 18&#39;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; &lt;a href=&#39;vscode-notebook-cell:/Users/adjourner/Projects/diffusion_curvature/sparse_matrices_exploration.ipynb#ch0000017?line=0&#39;&gt;1&lt;/a&gt;</span> A8_manual

<span class="ansi-red-fg">NameError</span>: name &#39;A8_manual&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">A8_manual</span> <span class="o">=</span> <span class="n">A8_manual</span> <span class="o">@</span> <span class="n">A8_manual</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-intense-fg ansi-bold">The Kernel crashed while executing code in the the current cell or a previous cell. Please review the code in the cell(s) to identify a possible cause of the failure. Click &lt;a href=&#39;https://aka.ms/vscodeJupyterKernelCrash&#39;&gt;here&lt;/a&gt; for more info. View Jupyter &lt;a href=&#39;command:jupyter.viewOutput&#39;&gt;log&lt;/a&gt; for further details.</span></pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-intense-fg ansi-bold">Canceled future for execute_request message before replies were done</span></pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For excessive numbers of points, diffusing between each of them repeatedly ceases to make sense -- hence the appeal of <em>landmarking</em>. PHATE uses landmarks to approximate large powers of the diffusion matrix, by (in effect) subsampling to a smaller number of "landmarks" and building a diffusion matrix between these.</p>
<p>In PHATE, the landmark matrix is powered and used by itself. This could produce a laziness measure of the landmarked points (which works quickly for up to 10,000 points). But how to extend this laziness back to the other points?</p>
<p>One obvious solution is to diffuse the laziness of the landmark points down to each of the other points.</p>

</div>
</div>
</div>
</div>
 

